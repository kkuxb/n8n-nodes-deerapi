# 跨节点 Binary 读取功能设计

**版本**: 1.5.6
**日期**: 2026-02-04
**状态**: 已确认

---

## 功能概述

新增"Binary 来源模式"下拉选项，支持三种读取方式：

| 模式 | 值 | 行为 |
|------|-----|------|
| 当前节点输入 | `current` | 默认模式，只读取直接输入的 Binary（现有行为） |
| 遍历所有上游节点 | `all` | 从近到远遍历所有已执行的上游节点 |
| 指定节点 | `specified` | 按用户指定的节点名称列表读取 |

---

## UI 参数设计

### 新增参数

1. **Binary 来源模式** (binarySourceMode)
   - 类型：下拉选择
   - 选项：
     - 当前节点输入 (current) - 默认
     - 遍历所有上游节点 (all)
     - 指定节点 (specified)
   - 显示条件：text、image、video-create 模式

2. **指定节点名称** (sourceNodeNames)
   - 类型：文本框
   - 格式：逗号分隔的节点名称
   - 占位符：`HTTP Request, Read File, Code`
   - 显示条件：仅当 binarySourceMode = specified

3. **图片属性名** (binaryPropertyName)
   - 保持现有参数不变
   - 默认值：`data, data0, data1, data2, file, attachment`

---

## 设计决策

| 决策点 | 选择 | 说明 |
|--------|------|------|
| 节点识别方式 | 精确名称匹配 | 用户必须输入准确的节点名 |
| Binary 合并策略 | 自动重命名 | data, data0, data1, data2... |
| 模式切换 UI | 下拉选择 | 清晰明确 |
| 多节点输入方式 | 逗号分隔文本框 | 简单直接 |
| 错误处理 | 静默忽略 | 找不到节点或无 Binary 时跳过 |
| 遍历顺序 | 从近到远 | 最近的节点数据优先 |
| 应用范围 | 现有范围 | text、image、video-create |

---

## 数据读取流程

```
1. 获取来源模式 (binarySourceMode)
   │
   ├─ current: 直接使用 getInputData() 获取当前输入
   │
   ├─ all:
   │   ├─ 调用 getWorkflowDataProxy() 获取工作流代理
   │   ├─ 通过 getExecuteData().source 追溯上游节点链
   │   ├─ 从近到远遍历，收集所有节点的 Binary
   │   └─ 按 data, data0, data1... 命名合并
   │
   └─ specified:
       ├─ 解析用户输入的节点名称列表
       ├─ 调用 $items(nodeName) 获取指定节点数据
       ├─ 静默跳过找不到的节点
       └─ 按 data, data0, data1... 命名合并

2. 遍历合并后的 Binary，按属性名列表提取图片

3. 传递给现有的 API 调用逻辑
```

---

## 使用场景示例

### 场景1：简单工作流
```
[HTTP Request] → [DeerAPI 文字生成]
```
- 使用"当前节点输入"模式（默认）
- 行为与现有版本完全一致

### 场景2：多图片来源
```
[HTTP Request 获取图片A] → [Read File 读取图片B] → [DeerAPI 图像生成]
```
- 选择"遍历所有上游节点"
- 自动收集图片A和图片B，命名为 data, data0

### 场景3：复杂分支工作流
```
[HTTP Request] ─┬→ [处理节点1] ─┬→ [DeerAPI]
[Read File] ────┘              │
[其他节点] ────────────────────┘
```
- 选择"指定节点"，输入 `HTTP Request, Read File`
- 只读取指定的两个节点，忽略其他

---

## 边界情况处理

| 情况 | 处理方式 |
|------|----------|
| 指定的节点不存在 | 静默跳过 |
| 节点存在但无 Binary | 静默跳过 |
| 所有来源都无图片 | 正常执行（无图片输入） |
| 图片数量超过 API 限制 | 按现有逻辑截取前N张 |

---

## 兼容性保证

| 方面 | 保证 |
|------|------|
| 默认行为 | "Binary 来源模式"默认为"当前节点输入"，与现有版本行为一致 |
| 现有工作流 | 不受影响，无需修改即可正常运行 |
| 参数命名 | 新参数不与现有参数冲突 |

---

## 功能应用范围

| 模式 | 是否支持跨节点读取 |
|------|-------------------|
| 文字生成 | 支持 |
| 图像生成 | 支持 |
| 视频生成 - 创建 | 支持 |
| 视频生成 - 其他操作 | 不适用 |
| 向量嵌入 | 不适用 |
